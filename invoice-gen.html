<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .invoice-container { max-width: 800px; margin: 40px auto; background-color: #fff; border: 1px solid #dee2e6; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); padding: 30px; font-family: Arial, sans-serif; border-radius: 8px; }
        .company-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .company-logo { max-width: 80px; height: auto; }
        .company-info { text-align: right; }
        .details-section { margin-bottom: 20px; }
        .table th, .table td { font-size: 14px; padding: 8px; border: 1px solid #dee2e6; /* Fallback */ box-shadow: 0 0 0 1px #dee2e6; /* PDF fix */ }
        .table th { background-color: #e9ecef; color: #343a40; }
        .total-row th, .total-row td { font-weight: bold; background-color: #d1e7dd; }
        .amount-in-words { background-color: #d1e7dd; padding: 10px; border: 1px dashed #0f5132; border-radius: 5px; font-weight: bold; margin-top: 20px; font-size: 14px; }
        #form-section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); margin-bottom: 20px; }
        .add-item-btn { margin-top: 10px; }
        .total-box { margin-top: 20px; }
        .tax-rate-field { width: 80px; }
        .notes-box { padding: 15px; background-color: #f2f2f2; border-radius: 5px; border: 1px solid #e0e0e0; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="form-section">
            <h2 class="mb-4 text-center">Generate Invoice</h2>
            <form id="invoice-form">
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="customerName" class="form-label">Customer Name</label><input type="text" class="form-control" id="customerName"></div>
                    <div class="col-md-6 mb-3"><label for="customerAddress" class="form-label">Customer Address</label><input type="text" class="form-control" id="customerAddress"></div>
                    <div class="col-md-6 mb-3"><label for="customerGst" class="form-label">Customer GSTIN</label><input type="text" class="form-control" id="customerGst"></div>
                    <div class="col-md-6 mb-3">
                        <label for="customerState" class="form-label">Customer State</label>
                        <select class="form-select" id="customerState">
                            <option value="Delhi">Delhi</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</Gujarat>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</Karnataka>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</Maharashtra>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="invoiceNo" class="form-label">Invoice Number</label><input type="text" class="form-control" id="invoiceNo"></div>
                    <div class="col-md-4 mb-3"><label for="invoiceDate" class="form-label">Invoice Date</label><input type="date" class="form-control" id="invoiceDate" onchange="updateDueDate()"></div>
                    <div class="col-md-4 mb-3"><label for="dueDate" class="form-label">Due Date</label><input type="date" class="form-control" id="dueDate" readonly></div>
                </div>
                
                <h4 class="mt-4">Ship To Details <small class="form-text text-muted"> (Optional)</small></h4>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="sameAsBilling" checked onchange="syncShippingAddress()">
                    <label class="form-check-label" for="sameAsBilling">Shipping same as billing</label>
                </div>
                <div class="row" id="shipping-fields" style="display: none;">
                    <div class="col-md-6 mb-3"><label for="shippingName" class="form-label">Shipping Name</label><input type="text" class="form-control" id="shippingName"></div>
                    <div class="col-md-6 mb-3"><label for="shippingAddress" class="form-label">Shipping Address</label><input type="text" class="form-control" id="shippingAddress"></div>
                    <div class="col-md-6 mb-3"><label for="shippingGst" class="form-label">Shipping GSTIN</label><input type="text" class="form-control" id="shippingGst"></div>
                    <div class="col-md-6 mb-3">
                        <label for="shippingState" class="form-label">Shipping State</label>
                        <select class="form-select" id="shippingState">
                            <option value="Delhi">Delhi</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</Gujarat>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</Karnataka>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</Maharashtra>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</Rajasthan>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                </div>

                <h4 class="mt-4">Invoice Notes <small class="form-text text-muted"> (Optional)</small></h4>
                <div class="mb-3">
                    <textarea class="form-control" id="invoiceNotes" rows="3"></textarea>
                </div>
                
                <h4 class="mt-4">Invoice Items</h4>
                <table class="table table-bordered" id="itemsTable">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Unit Price (₹)</th>
                            <th>Quantity</th>
                            <th>Tax Rate (%)</th>
                            <th>Total (Inc. Tax) (₹)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="form-control item-desc"></td>
                            <td><input type="number" class="form-control item-price"></td>
                            <td><input type="number" class="form-control item-qty"></td>
                            <td><input type="number" class="form-control item-tax-rate" value="0"></td>
                            <td><input type="text" class="form-control item-total" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-secondary add-item-btn" onclick="addItemRow()">Add Item</button>
                
                <button type="button" class="btn btn-success w-100 mt-4" onclick="generateInvoice()">Generate Invoice</button>
            </form>
        </div>

        <div class="invoice-container" id="invoice-slip" style="display: none;">
            <div class="company-header">
                <div>
                    <img id="slipCompanyLogo" src="assets/branding/logo.webp" alt="Company Logo" class="company-logo">
                    <h2 id="slipCompanyName">CYBER ALLIANCE INDIA</h2>
                    <p id="slipCompanyAddress">DWARKA SECTOR - 24, NEW DELHI - 110077</p>
                    <p>COMPANY PAN: <span id="slipCompanyGst">AAVFC4620K</span></p>
                </div>
                <div class="company-info">
                    <h1>INVOICE</h1>
                    <p><strong>Invoice #:</strong> <span id="slipInvoiceNo"></span></p>
                    <p><strong>Date:</strong> <span id="slipInvoiceDate"></span></p>
                    <p><strong>Due Date:</strong> <span id="slipDueDate"></span></p>
                </div>
            </div>
            <hr>
            <div class="details-section">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-2">Bill To:</h5>
                        <p><strong><span id="slipCustomerName"></span></strong></p>
                        <p><span id="slipCustomerAddress"></span></p>
                        <p>GSTIN: <span id="slipCustomerGst"></span></p>
                        <p>State: <span id="slipCustomerState"></span></p>
                    </div>
                    <div class="col-md-6" id="slipShippingDetails">
                        <h5 class="mb-2">Ship To:</h5>
                        <p><strong><span id="slipShippingName"></span></strong></p>
                        <p><span id="slipShippingAddress"></span></p>
                        <p>GSTIN: <span id="slipShippingGst"></span></p>
                        <p>State: <span id="slipShippingState"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-end">Taxable Value (₹)</th>
                            <th class="text-end" id="tax-header-igst">IGST</th>
                            <th class="text-end" id="tax-header-cgst">CGST</th>
                            <th class="text-end" id="tax-header-sgst">SGST</th>
                            <th class="text-end">Total (Inc. Tax) (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                        </tbody>
                </table>
            </div>

            <div class="row" style="align-items: flex-end;">
                <div class="col-md-6">
                    <div class="notes-box" id="slipNotes" style="display: none;">
                        <h5 class="mb-2">Notes:</h5>
                        <p id="slipInvoiceNotesContent"></p>
                    </div>
                </div>
                <div class="col-md-6 total-box">
                    <table class="table table-bordered mb-0">
                        <tbody>
                            <tr>
                                <td class="text-end"><strong>Total Taxable Value:</strong></td>
                                <td class="text-end" id="slipTotalTaxable"></td>
                            </tr>
                            <tr id="igst-row">
                                <td class="text-end"><strong>Total IGST:</strong></td>
                                <td class="text-end" id="slipTotalIgst"></td>
                            </tr>
                            <tr id="cgst-row">
                                <td class="text-end"><strong>Total CGST:</strong></td>
                                <td class="text-end" id="slipTotalCgst"></td>
                            </tr>
                            <tr id="sgst-row">
                                <td class="text-end"><strong>Total SGST:</strong></td>
                                <td class="text-end" id="slipTotalSgst"></td>
                            </tr>
                            <tr class="total-row">
                                <td class="text-end"><strong>Grand Total:</strong></td>
                                <td class="text-end" id="slipGrandTotal"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="amount-in-words" id="slipAmountWords"></div>
            
            <div class="mt-4">
                <h5 class="mb-0">Payment Details</h5>
                <p class="mb-0 mt-2"><strong>Name:</strong> Yudhvir Singh Godara</p>
                <p class="mb-0"><strong>Bank:</strong> HDFC, BAMNOLI</p>
                <p class="mb-0"><strong>UPI ID:</strong> 8851573195@hdfcbank</p>
                <p class="mb-0"><strong>Account No:</strong> 50100474325290</p>
                <p class="mb-0"><strong>IFSC Code:</strong> HDFC0000338</p>
            </div>

            <div class="mt-4 text-center">
                <p>Thank you for your business!</p>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button onclick="downloadPdf()" class="btn btn-primary btn-lg" style="display: none;">Download as PDF</button>
        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Helper function to format numbers with commas
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Number to words conversion (Lakhs and Crores)
        function numberToWords(num) {
            const s = num.toFixed(2).split('.')[0];
            const n = ('000000000' + s).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            const processNumber = (number, unit) => {
                const numberInt = parseInt(number, 10);
                if (numberInt === 0) return '';
                if (numberInt < 20) return a[numberInt] + ' ' + unit;
                return b[number[0]] + ' ' + a[number[1]] + ' ' + unit;
            };

            str += processNumber(n[1], 'Crore ');
            str += processNumber(n[2], 'Lakh ');
            str += processNumber(n[3], 'Thousand ');
            str += processNumber(n[4], 'Hundred ');
            
            if (n[5] !== '00') {
                if (str !== '') {
                    str += 'and ';
                }
                const lastTwoDigits = parseInt(n[5], 10);
                if (lastTwoDigits < 20) {
                    str += a[lastTwoDigits];
                } else {
                    str += b[n[5][0]] + ' ' + a[n[5][1]];
                }
            }
            return str.trim() + ' Rupees Only';
        }

        // Initialize invoice number and date on load
        document.addEventListener('DOMContentLoaded', () => {
            const currentYear = new Date().getFullYear();
            const random = Math.floor(1000 + Math.random() * 9000);
            const invoiceNumber = `${currentYear}-${random}`;
            document.getElementById('invoiceNo').value = invoiceNumber;
            document.getElementById('invoiceDate').valueAsDate = new Date();
            updateDueDate();
            addEventListenersToRow(document.querySelector('#itemsTable tbody tr'));
            updateTaxRate(); // Call this to set initial tax rate based on GSTIN
        });

        function updateDueDate() {
            const invoiceDate = document.getElementById('invoiceDate').valueAsDate;
            if (invoiceDate) {
                const dueDate = new Date(invoiceDate);
                dueDate.setDate(dueDate.getDate() + 1);
                document.getElementById('dueDate').valueAsDate = dueDate;
            }
        }
        
        // This function will update all item tax rates based on the GSTIN input
        function updateTaxRate() {
            const customerGst = document.getElementById('customerGst').value.trim();
            const defaultRate = customerGst ? 18 : 0;
            const itemTaxRateInputs = document.querySelectorAll('.item-tax-rate');
            itemTaxRateInputs.forEach(input => {
                // Only update if the field hasn't been manually changed by the user
                if (input.value === '0' || input.value === '18' || input.dataset.initial === 'true') {
                     input.value = defaultRate;
                     input.dataset.initial = 'true'; // Mark as initially set
                }
            });
            // Update rates for any new rows added later
            const addItemButton = document.querySelector('.add-item-btn');
            addItemButton.onclick = () => addItemRow(defaultRate);
        }
        
        document.getElementById('customerGst').addEventListener('input', updateTaxRate);

        function syncShippingAddress() {
            const sameAsBilling = document.getElementById('sameAsBilling').checked;
            const shippingFields = document.getElementById('shipping-fields');
            
            if (sameAsBilling) {
                shippingFields.style.display = 'none';
                document.getElementById('shippingName').value = '';
                document.getElementById('shippingAddress').value = '';
                document.getElementById('shippingGst').value = '';
                document.getElementById('shippingState').value = 'Delhi'; // Reset to default state
            } else {
                shippingFields.style.display = 'flex';
            }
        }

        function addItemRow(defaultRate = null) {
            const tableBody = document.querySelector('#itemsTable tbody');
            const newRow = document.createElement('tr');
            if (defaultRate === null) {
                const customerGst = document.getElementById('customerGst').value.trim();
                defaultRate = customerGst ? 18 : 0;
            }
            
            newRow.innerHTML = `
                <td><input type="text" class="form-control item-desc"></td>
                <td><input type="number" class="form-control item-price"></td>
                <td><input type="number" class="form-control item-qty"></td>
                <td><input type="number" class="form-control item-tax-rate" value="${defaultRate}"></td>
                <td><input type="text" class="form-control item-total" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
            `;
            tableBody.appendChild(newRow);
            addEventListenersToRow(newRow);
        }

        function addEventListenersToRow(row) {
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const taxRateInput = row.querySelector('.item-tax-rate');
            const totalInput = row.querySelector('.item-total');

            const calculateItemTotal = () => {
                const price = parseFloat(priceInput.value) || 0;
                const qty = parseFloat(qtyInput.value) || 0;
                const taxRate = parseFloat(taxRateInput.value) || 0;
                
                const taxableAmount = price * qty;
                const gstRate = taxRate / 100;
                const total = taxableAmount + (taxableAmount * gstRate);
                
                totalInput.value = formatNumber(total);
            };

            priceInput.addEventListener('input', calculateItemTotal);
            qtyInput.addEventListener('input', calculateItemTotal);
            taxRateInput.addEventListener('input', calculateItemTotal);

            row.querySelector('.remove-item').addEventListener('click', (e) => {
                e.target.closest('tr').remove();
            });
        }

        function generateInvoice() {
            const customerName = document.getElementById('customerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const customerGst = document.getElementById('customerGst').value;
            const customerState = document.getElementById('customerState').value;
            const invoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const invoiceNotes = document.getElementById('invoiceNotes').value;

            // Shipping details
            const sameAsBilling = document.getElementById('sameAsBilling').checked;
            const shippingName = sameAsBilling ? customerName : document.getElementById('shippingName').value;
            const shippingAddress = sameAsBilling ? customerAddress : document.getElementById('shippingAddress').value;
            const shippingGst = sameAsBilling ? customerGst : document.getElementById('shippingGst').value;
            const shippingState = sameAsBilling ? customerState : document.getElementById('shippingState').value;

            const isGstinProvided = customerGst.trim() !== '';
            let totalTaxableValue = 0;
            let totalCgst = 0;
            let totalSgst = 0;
            let totalIgst = 0;
            
            const invoiceItemsHtml = document.getElementById('invoice-items');
            invoiceItemsHtml.innerHTML = '';

            const isIntraState = customerState.toLowerCase() === 'delhi';

            const itemRows = document.querySelectorAll('#itemsTable tbody tr');
            itemRows.forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const taxRate = parseFloat(row.querySelector('.item-tax-rate').value) || 0;
                
                if (!desc) return; // Skip empty rows

                const taxableAmount = price * qty;
                totalTaxableValue += taxableAmount;

                let effectiveGstRate = isGstinProvided ? (taxRate / 100) : 0;
                let itemCgst = 0, itemSgst = 0, itemIgst = 0;
                let totalAmount = taxableAmount;

                if (effectiveGstRate > 0) {
                    if (isIntraState) {
                        itemCgst = taxableAmount * (effectiveGstRate / 2);
                        itemSgst = taxableAmount * (effectiveGstRate / 2);
                        totalCgst += itemCgst;
                        totalSgst += itemSgst;
                        totalAmount += itemCgst + itemSgst;
                    } else {
                        itemIgst = taxableAmount * effectiveGstRate;
                        totalIgst += itemIgst;
                        totalAmount += itemIgst;
                    }
                }
                
                let itemHtml = `<tr>
                    <td>${desc}</td>
                    <td class="text-end">${formatNumber(taxableAmount)}</td>
                    <td class="text-end">${formatNumber(itemIgst)}</td>
                    <td class="text-end">${formatNumber(itemCgst)}</td>
                    <td class="text-end">${formatNumber(itemSgst)}</td>
                    <td class="text-end">${formatNumber(totalAmount)}</td>
                </tr>`;
                invoiceItemsHtml.innerHTML += itemHtml;
            });

            const grandTotal = totalTaxableValue + totalCgst + totalSgst + totalIgst;
            
            // Re-update headers and total rows for display
            if (isIntraState) {
                const effectiveTaxRate = totalTaxableValue > 0 ? ((totalCgst + totalSgst) / totalTaxableValue) * 100 : 0;
                document.getElementById('tax-header-igst').innerText = `IGST (0%)`;
                document.getElementById('tax-header-cgst').innerText = `CGST (${(effectiveTaxRate / 2).toFixed(1)}%)`;
                document.getElementById('tax-header-sgst').innerText = `SGST (${(effectiveTaxRate / 2).toFixed(1)}%)`;
                
                document.getElementById('igst-row').style.display = 'none';
                document.getElementById('cgst-row').style.display = 'table-row';
                document.getElementById('sgst-row').style.display = 'table-row';
            } else {
                const effectiveTaxRate = totalTaxableValue > 0 ? (totalIgst / totalTaxableValue) * 100 : 0;
                document.getElementById('tax-header-igst').innerText = `IGST (${(effectiveTaxRate).toFixed(0)}%)`;
                document.getElementById('tax-header-cgst').innerText = `CGST (0%)`;
                document.getElementById('tax-header-sgst').innerText = `SGST (0%)`;
                
                document.getElementById('igst-row').style.display = 'table-row';
                document.getElementById('cgst-row').style.display = 'none';
                document.getElementById('sgst-row').style.display = 'none';
            }
            
            // Update the invoice HTML with totals
            document.getElementById('slipInvoiceNo').innerText = invoiceNo;
            document.getElementById('slipInvoiceDate').innerText = invoiceDate;
            document.getElementById('slipDueDate').innerText = dueDate;
            document.getElementById('slipCustomerName').innerText = customerName;
            document.getElementById('slipCustomerAddress').innerText = customerAddress;
            document.getElementById('slipCustomerGst').innerText = customerGst;
            document.getElementById('slipCustomerState').innerText = customerState;
            document.getElementById('slipShippingName').innerText = shippingName;
            document.getElementById('slipShippingAddress').innerText = shippingAddress;
            document.getElementById('slipShippingGst').innerText = shippingGst;
            document.getElementById('slipShippingState').innerText = shippingState;
            document.getElementById('slipTotalTaxable').innerText = `₹ ${formatNumber(totalTaxableValue)}`;
            document.getElementById('slipTotalCgst').innerText = `₹ ${formatNumber(totalCgst)}`;
            document.getElementById('slipTotalSgst').innerText = `₹ ${formatNumber(totalSgst)}`;
            document.getElementById('slipTotalIgst').innerText = `₹ ${formatNumber(totalIgst)}`;
            document.getElementById('slipGrandTotal').innerText = `₹ ${formatNumber(grandTotal)}`;
            document.getElementById('slipAmountWords').innerText = `Total Amount in Words: ${numberToWords(grandTotal)}`;

            // Handle notes display
            if (invoiceNotes.trim() !== '') {
                document.getElementById('slipNotes').style.display = 'block';
                document.getElementById('slipInvoiceNotesContent').innerText = invoiceNotes;
            } else {
                document.getElementById('slipNotes').style.display = 'none';
                document.getElementById('slipInvoiceNotesContent').innerText = ''; // Clear content
            }
            showInvoice();
        }

        function showInvoice() {
            document.getElementById('form-section').style.display = 'none';
            document.getElementById('invoice-slip').style.display = 'block';
            document.querySelector('.btn-primary').style.display = 'block';
        }

        function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('invoice-slip');
            const downloadBtn = document.querySelector('.btn-primary');
            const invoiceNo = document.getElementById('slipInvoiceNo').innerText;
            const customerName = document.getElementById('slipCustomerName').innerText;

            downloadBtn.style.display = 'none';

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Set PDF properties with the correct 'creator' field
                pdf.setProperties({
                    title: `INVOICE NO ${invoiceNo.toUpperCase()}`,
                    subject: `${customerName.toUpperCase()} - INVOICE NO ${invoiceNo.toUpperCase()}`,
                    author: `Cyber Alliance India`,
                    creator: `Cyber Alliance India - Invoice Generator`,
                });

                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`invoice-${invoiceNo}.pdf`);
                
                downloadBtn.style.display = 'block';
            });
        }
    </script>
</body>
</html>